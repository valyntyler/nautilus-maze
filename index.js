(()=>{var W;(s=>{function a(r=14,i=15){return Array(r).fill([]).map(()=>Array(i).fill(0))}s.create=a;function t(r){return r.length}s.rows=t;function e(r){return r[0].length}s.cols=e;function o(r,i){let f=s.rows(i),O=s.cols(i);return!(r.x<0||r.x>=O||r.y<0||r.y>=f)}s.contains=o;function n(r,i){return i[r.y][r.x]===1}s.isWall=n})(W||={});var h=W;var M=(n=>(n[n.Up=0]="Up",n[n.Down=1]="Down",n[n.Left=2]="Left",n[n.Right=3]="Right",n))(M||{});(o=>{function a(n){switch(n){case 0:return"up";case 1:return"down";case 2:return"left";case 3:return"right"}}o.id=a;function t(n){switch(n){case"up":return 0;case"down":return 1;case"left":return 2;case"right":return 3;default:return null}}o.parse=t;function e(n){switch(n){case 0:return 2;case 2:return 1;case 1:return 3;case 3:return 0}}o.turn=e})(M||={});var d=M;var F;(o=>{function a(n=0,s=0){return{x:n,y:s}}o.create=a;function t(n,s){switch(s){case d.Up:return{x:n.x,y:n.y-1};case d.Down:return{x:n.x,y:n.y+1};case d.Left:return{x:n.x-1,y:n.y};case d.Right:return{x:n.x+1,y:n.y}}}o.step=t;function e(n,s){switch(s){case d.Up:return{x:n.x,y:n.y+1};case d.Down:return{x:n.x,y:n.y-1};case d.Left:return{x:n.x+1,y:n.y};case d.Right:return{x:n.x-1,y:n.y}}}o.back=e})(F||={});var C=F;var U;(n=>{function a(s=C.create(),r=d.Up){return{position:s,rotation:r}}n.create=a;function t(s){return{position:C.step(s.position,s.rotation),rotation:s.rotation}}n.step=t;function e(s){return{position:C.back(s.position,s.rotation),rotation:s.rotation}}n.back=e;function o(s){return{position:s.position,rotation:d.turn(s.rotation)}}n.turn=o})(U||={});var x=U;var _=(s=>(s[s.Step=0]="Step",s[s.Back=1]="Back",s[s.Move=2]="Move",s[s.Left=3]="Left",s[s.Turn=4]="Turn",s))(_||{});(o=>{function a(n){switch(n){case 0:return"step";case 1:return"back";case 2:return"move";case 3:return"left";case 4:return"turn"}}o.name=a;function t(n){switch(n.toLowerCase()){case"step":return 0;case"back":return 1;case"move":return 2;case"left":return 3;case"turn":return 4;default:return null}}o.parse=t;function e(n,s,r){switch(n){case 0:{let i=x.step(s);return h.contains(i.position,r)&&!h.isWall(i.position,r)?i:s}case 1:{let i=x.back(s);return h.contains(i.position,r)&&!h.isWall(i.position,r)?i:s}case 2:{let i=x.step(s);return h.contains(i.position,r)&&!h.isWall(i.position,r)?o.run(n,i,r):s}case 3:{let i=x.step(s),f=x.step(x.turn(s));return h.contains(i.position,r)&&!h.isWall(i.position,r)&&h.isWall(f.position,r)?o.run(n,i,r):s}case 4:return x.turn(s)}}o.run=e})(_||={});var E=_;var R=(o=>(o[o.Pencil=0]="Pencil",o[o.Eraser=1]="Eraser",o[o.Finger=2]="Finger",o))(R||{});(o=>{function a(n){switch(n){case 0:return"pencil";case 1:return"eraser";case 2:return"finger"}}o.id=a;function t(n){switch(n){case 0:return"./assets/bx-pencil-draw.svg";case 1:return"./assets/bx-eraser.svg";case 2:return"./assets/bx-finger-up.svg"}}o.img=t;function e(n){switch(n){case"pencil":return 0;case"eraser":return 1;case"finger":return 2;default:return null}}o.parse=e})(R||={});var p=R;var j=(e=>(e[e.View=0]="View",e[e.Edit=1]="Edit",e))(j||{}),v=j;var J;(Q=>{function a(){let c=localStorage.getItem("commands");return c?JSON.parse(c):[]}Q.get_commands=a;function t(c){localStorage.setItem("commands",JSON.stringify(c))}Q.set_commands=t;function e(){let c=localStorage.getItem("grid");return c?JSON.parse(c):h.create()}Q.get_maze=e;function o(c){localStorage.setItem("grid",JSON.stringify(c))}Q.set_maze=o;function n(){let c=localStorage.getItem("robot");return c?JSON.parse(c):x.create()}Q.get_robot=n;function s(c){localStorage.setItem("robot",JSON.stringify({position:c.position,rotation:c.rotation}))}Q.set_robot=s;function r(){let c=localStorage.getItem("selected-tool");return c?JSON.parse(c):p.Pencil}Q.get_tool=r;function i(c){localStorage.setItem("selected-tool",JSON.stringify(c))}Q.set_tool=i;function f(){let c=localStorage.getItem("active-window");return c?JSON.parse(c):v.View}Q.get_window=f;function O(c){localStorage.setItem("active-window",JSON.stringify(c))}Q.set_window=O})(J||={});var l=J;var T=class{constructor(t,e){this.transform=t;this.grid=e;this.html(),this.revive()}get steps(){let t=this.transform;return[this.transform,...this.state.map(e=>(t=E.run(e,t,this.grid),t))]}set selected(t){Array.from(this.container.children).forEach(e=>e.classList.remove("selected")),t!==null&&this.container.children[t].classList.add("selected")}container;get state(){return Array.from(this.container.children).map(t=>E.parse(t.children[0].textContent)).filter(t=>t!==null)}set state(t){l.set_commands(t)}appendCommand(t){let e=document.createElement("div"),o=document.createElement("div"),n=document.createElement("button");e.className="command",o.textContent=E.name(t),n.textContent="-",n.onclick=()=>{e.remove(),this.state=this.state},e.appendChild(o),e.appendChild(n),this.container.appendChild(e)}html(){this.container=document.getElementById("commands"),this.container.innerHTML="";let t=document.getElementById("command-prompt"),e=t.elements.namedItem("command");t.addEventListener("submit",o=>{o.preventDefault();let n=E.parse(e.value);n!==null&&(this.appendCommand(n),e.value="",this.state=this.state)})}revive(){l.get_commands().forEach(t=>this.appendCommand(t))}};var H=(r=>(r[r.Prev=0]="Prev",r[r.Next=1]="Next",r[r.Play=2]="Play",r[r.Stop=3]="Stop",r[r.Pause=4]="Pause",r[r.Toggle=5]="Toggle",r))(H||{});(t=>{function a(e){switch(e){case 0:return{name:"prev"};case 1:return{name:"next"};case 2:return{name:"play"};case 3:return{name:"stop"};case 4:return{name:"pause"};case 5:return{name:"toggle"}}}t.object=a})(H||={});var m=H;var I=(r=>(r[r.Prev=0]="Prev",r[r.Next=1]="Next",r[r.Play=2]="Play",r[r.Stop=3]="Stop",r[r.Pause=4]="Pause",r[r.Reset=5]="Reset",r))(I||{});(t=>{function a(e){switch(e){case 0:return{name:"prev",source:"./assets/bx-skip-previous.svg",event:m.Prev};case 1:return{name:"next",source:"./assets/bx-skip-next.svg",event:m.Next};case 2:return{name:"play",source:"./assets/bx-play.svg",event:m.Play};case 3:return{name:"stop",source:"./assets/bx-stop.svg",event:m.Stop};case 4:return{name:"pause",source:"./assets/bx-pause.svg",event:m.Pause};case 5:return{name:"reset",source:"./assets/bx-rotate-ccw.svg",event:m.Stop}}}t.object=a})(I||={});var u=I;var D=(o=>(o[o.Waiting=0]="Waiting",o[o.Running=1]="Running",o[o.Finished=2]="Finished",o))(D||{});(t=>{function a(e){switch(e){case 0:return[u.Stop,u.Prev,u.Play,u.Next];case 1:return[u.Stop,u.Prev,u.Pause,u.Next];case 2:return[u.Stop,u.Prev,u.Reset,u.Next]}}t.controls=a})(D||={});var g=D;var L=class{constructor(t){this.commands=t;this.html(),this.hookup()}onstepchange=()=>{};container;_state=g.Waiting;_index=0;get state(){return this._state}set state(t){this._state=t,this.html()}get index(){return this._index}set index(t){t<0||t>=this.commands.steps.length||(this._index=t,this.onstepchange(t,this.commands.steps[t]))}html(){this.container=document.getElementById("playback"),this.container.innerHTML="";for(let t of g.controls(this.state)){let e=u.object(t),o=document.createElement("img");o.alt=e.name,o.src=e.source,o.draggable=!1,o.onclick=()=>this.onevent(e.event),t===u.Prev&&this.index===0&&o.classList.add("disabled"),t===u.Next&&this.index+1===this.commands.steps.length&&o.classList.add("disabled"),this.container.appendChild(o)}}hookup(){document.addEventListener("keydown",t=>{switch(t.key){case"ArrowLeft":{this.onevent(m.Prev);break}case"ArrowRight":{this.onevent(m.Next);break}case"c":{t.ctrlKey&&this.onevent(m.Stop);break}case" ":{let e=!1;if(document.querySelectorAll(".overlay").forEach(o=>{o.classList.contains("hidden")||(e=!0)}),e)return;t.target===document.body&&this.onevent(m.Toggle);break}}})}async onevent(t){switch(t){case m.Prev:{this.index--,this.state=g.Waiting;break}case m.Next:{this.index++,this.index===this.commands.steps.length-1?this.state=g.Finished:this.state=g.Waiting;break}case m.Play:{for(this.state=g.Running;this.index<this.commands.steps.length-1;)if(this.index++,this.html(),console.log(this.index),await this.signal(500))return;this.state=g.Finished;break}case m.Stop:{this.state=g.Waiting,this.index=0,this.html();break}case m.Pause:{this.state=g.Waiting;break}case m.Toggle:{switch(this.state){case g.Waiting:{this.onevent(m.Play);break}case g.Running:{this.onevent(m.Pause);break}case g.Finished:{this.onevent(m.Stop);break}}break}}}async signal(t){let e=Date.now();for(;Date.now()-e<=t;)if(await new Promise(o=>setTimeout(o,1)),this.state!==g.Running)return!0;return!1}};var V=(e=>(e[e.White=0]="White",e[e.Black=1]="Black",e))(V||{}),z=V;var $=(e=>(e[e.Down=0]="Down",e[e.Enter=1]="Enter",e))($||{}),N=$;var q;(t=>{function a(e){return{left:(e&1)!=0,right:(e&2)!=0,middle:(e&4)!=0}}t.parse=a})(q||={});var A=q;var k=class{onevent=()=>{};get state(){return Array.from(this.container.children).map(t=>Array.from(t.children).map(e=>e.classList.contains("black")?z.Black:z.White))}container;html(){let t=document.getElementById("puzzle"),e=document.createElement("div");e.id="maze",e.classList="maze-container",this.container=e,t.appendChild(this.container)}grid(t){this.container.innerHTML="";let e=h.rows(t),o=h.cols(t);document.documentElement.style.setProperty("--grid-rows",`${e}`),document.documentElement.style.setProperty("--grid-cols",`${o}`);for(let n=0;n<e;n++){let s=document.createElement("div");s.classList.add("maze-row");for(let r=0;r<o;r++){let i=document.createElement("div");i.classList.add("maze-cell"),t[n][r]===z.Black&&i.classList.add("black"),i.addEventListener("mousedown",f=>this.onevent(i,N.Down,A.parse(f.buttons))),i.addEventListener("mouseenter",f=>this.onevent(i,N.Enter,A.parse(f.buttons))),i.addEventListener("contextmenu",f=>f.preventDefault()),s.appendChild(i)}this.container.appendChild(s)}}constructor(t){this.html(),this.grid(t)}};var P=class{get state(){return{position:this.position,rotation:this.rotation}}set state(t){this.position=t.position,this.rotation=t.rotation}element;_position;_rotation;get position(){return this._position}get rotation(){return this._rotation}set position(t){this._position=t;let e={property:"--robot-x",value:`${t.x}`},o={property:"--robot-y",value:`${t.y}`};document.documentElement.style.setProperty(e.property,e.value),document.documentElement.style.setProperty(o.property,o.value)}set rotation(t){if(t===d.Up&&this.rotation===d.Right){let e=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--rotations"),10);document.documentElement.style.setProperty("--rotations",`${e+1}`)}if(t===d.Right&&this.rotation===d.Up){let e=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--rotations"),10);document.documentElement.style.setProperty("--rotations",`${e-1}`)}this._rotation=t,this.element.dataset.rotation=d.id(t)}html(){let t=document.getElementById("puzzle"),e=document.createElement("img");e.id="robot",e.className="robot",e.src="./assets/bx-caret-up.svg",e.draggable=!1,e.dataset.rotation=d.id(this.rotation),t.appendChild(e),this.element=e}constructor(t){this.html(),this.state=t}};var y=class{container;maze;robot;constructor(){this.container=document.getElementById("puzzle"),this.container.innerHTML="",this.maze=new k(l.get_maze()),this.robot=new P(l.get_robot())}};var K;(o=>{let a=document.getElementById("right");function t(){a.innerHTML=`
      <form id="command-prompt">
        <input type="text" name="command" maxlength="4" />
        <button type="submit">+</button>
      </form>
      <div class="commands-container" id="commands"></div>
    `.trim()}o.show=t;function e(){a.innerHTML=""}o.hide=e})(K||={});var B=K;var b=class extends y{commands;playback;constructor(){super(),this.html(),this.commands=new T(this.robot.state,this.maze.state),this.playback=new L(this.commands),this.playback.onstepchange=(t,e)=>{Object.assign(this.robot,e),t===0?this.commands.selected=null:this.commands.selected=t-1}}html(){let t=document.createElement("div"),e=document.getElementById("bar");t.id="playback",t.className="playback-container",e.innerHTML="",e.appendChild(t),B.show()}};var S=class{container;get selected(){let e=document.querySelector(".tool input:checked").id;return p.parse(e)}set selected(t){let e=p.id(t),o=document.getElementById(e);o.checked=!0,l.set_tool(this.selected)}constructor(t=[p.Pencil,p.Eraser,p.Finger]){this.container=document.getElementById("tools");for(let e of t){let o=document.createElement("div"),n=document.createElement("input"),s=document.createElement("label"),r=document.createElement("img"),i=p.id(e);o.className="tool",n.id=i,n.name="tool",n.type="radio",s.setAttribute("for",i),r.src=p.img(e),r.alt=i,r.draggable=!1,s.appendChild(r),o.appendChild(n),o.appendChild(s),this.container.appendChild(o)}this.selected=l.get_tool(),document.addEventListener("keydown",e=>{switch(e.key){case"1":case"b":{this.selected=p.Pencil;break}case"2":case"e":{this.selected=p.Eraser;break}case"3":case"c":{this.selected=p.Finger;break}}})}};var w=class extends y{tools;onevent(t,e,o){switch(this.tools.selected){case p.Pencil:{this.usePencil(t,e,o);break}case p.Eraser:{this.useEraser(t,e,o);break}case p.Finger:{this.useFinger(t,e,o);break}}}usePencil(t,e,o){let n=t.parentElement,s=Array.from(n.children),r=Array.from(n.parentElement.children),i=s.indexOf(t),f=r.indexOf(n);o.left&&t.children.length===0&&(i!==this.robot.state.position.x||f!==this.robot.state.position.y)&&(t.classList.add("black"),l.set_maze(this.maze.state))}useEraser(t,e,o){o.left&&(t.classList.remove("black"),l.set_maze(this.maze.state))}useFinger(t,e,o){if(!t.classList.contains("black")){let n=t.parentElement,s=Array.from(n.children),r=Array.from(n.parentElement.children),i=s.indexOf(t),f=r.indexOf(n);o.left?(this.robot.state={position:{x:i,y:f},rotation:this.robot.state.rotation},l.set_robot(this.robot.state)):o.right&&i===this.robot.state.position.x&&f===this.robot.state.position.y&&(this.robot.state=x.turn(this.robot.state),l.set_robot(this.robot.state))}}html(){let t=document.createElement("div"),e=document.createElement("img"),o=document.getElementById("bar");t.id="tools",t.className="tools-container",e.src="./assets/bx-dots-vertical-rounded.svg",e.id="done",e.className="tool",o.innerHTML="",o.appendChild(t),o.appendChild(e),B.hide()}constructor(){super(),this.html(),this.tools=new S,this.maze.onevent=(t,e,o)=>this.onevent(t,e,o)}};document.addEventListener("DOMContentLoaded",()=>{let a;switch(l.get_window()){case v.View:{a=new b;break}case v.Edit:{a=new w;break}}let t=document.getElementById("overlay-success"),e=document.getElementById("overlay-failure"),o=document.getElementById("dismiss-success"),n=document.getElementById("dismiss-failure");o.addEventListener("click",()=>t.classList.add("hidden")),n.addEventListener("click",()=>e.classList.add("hidden"));let s=Array.from(document.getElementById("buttons").children);G(s),s[0].onclick=()=>{switch(l.get_window()){case v.View:{a=new w,l.set_window(v.Edit),G(s);break}case v.Edit:{a=new b,l.set_window(v.View),G(s);break}}},document.addEventListener("keydown",r=>{switch(r.key){case" ":case"Escape":document.querySelectorAll(".overlay").forEach(i=>i.classList.add("hidden"))}})});function G(a){let t=a[0].children[0],e=a[0].children[1],o=a[1].children[0],n=a[1].children[1];switch(l.get_window()){case v.View:{t.src="./assets/bx-edit-alt.svg",e.textContent="Edit",o.src="./assets/bx-arrow-out-up-square-half.svg",n.textContent="Upload";break}case v.Edit:{t.src="./assets/bx-check.svg",e.textContent="Done",o.src="./assets/bx-save.svg",n.textContent="Save";break}}}})();
